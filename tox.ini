[tox]
envlist = py3{6,7,8,9}-tests
skip_missing_interpreters = true
skipsdist = true

[testenv]
envdir = {toxinidir}/.env
skip_install = true

passenv =
    pythonLocation
    CC
    CXX
    CI
    GITHUB*
    PIP_DOWNLOAD_CACHE

setenv =
    clang: ENV_LLVM_VER = {env:ENV_LLVM_VER:12}
    {auto,bionic}: ENV_RIPC_RUNTIME_DIR = {env:ENV_RIPC_RUNTIME_DIR:{envtmpdir}}

whitelist_externals =
    {tests,clang,ctest,bionic,lint,grind,clean,auto,autoclean}: bash
    {tests,clang,bionic,grind,cover}: mkdir

changedir =
    {tests,bionic,clang,grind}: build

deps =
    {auto,tests,clang,ctest,bionic,grind,lint,cover}: pip>=19.0.1
    {tests,clang,ctest,bionic,grind}: cmake
    {tests,clang,ctest,bionic,grind}: ninja
    {auto,tests,ctest,bionic,cover}: gcovr
    lcov: lcov_cobertura @ https://github.com/sarnold/lcov-to-cobertura-xml/releases/download/1.6.1/lcov_cobertura-1.6.1-py3-none-any.whl
    auto: this-cli
    lint: cpplint
    lint: beautysh
    grind: ValgrindCI

commands_pre =
    bionic: mkdir -p {toxinidir}/coverage
    {tests,clang,bionic,grind}: mkdir -p {toxinidir}/build
    {tests,clang,ctest,grind}: bash -c '{toxinidir}/scripts/run_redis.sh start > /dev/null'
    {tests,clang,ctest,grind}: bash -c '{toxinidir}/scripts/run_redis.sh status'

commands =
    # sadly this-cli cannot pass args to configure
    #auto: this check
    bionic: bash -c 'cmake -G {posargs:"Unix Makefiles"} -DWITH_COVERAGE=1 -DCMAKE_BUILD_TYPE=Debug ..'
    bionic: bash -c 'cmake --build .'
    auto: bash -c 'autoreconf -fiv'
    auto: bash -c './configure {posargs:"--with-coverage"}'
    {auto,bionic}: bash -c 'make cov || true'
    {auto,bionic}: bash -c 'RIPC_RUNTIME_DIR=$ENV_RIPC_RUNTIME_DIR {toxinidir}/scripts/run_redis.sh start > /dev/null'
    {auto,bionic}: bash -c 'RIPC_RUNTIME_DIR=$ENV_RIPC_RUNTIME_DIR {toxinidir}/scripts/run_redis.sh status'
    {auto,bionic}: bash -c 'RIPC_SERVER_PATH=$ENV_RIPC_RUNTIME_DIR/socket make cov'
    clang: bash -c 'cmake -DRIPC_BUILD_TESTING=ON -DCOVERAGE_BUILD=ON -DCOVERAGE_HTML=ON -DLLVM_VER=$ENV_LLVM_VER ..'
    tests: bash -c 'cmake -DWITH_COVERAGE=1 -DCMAKE_BUILD_TYPE=Debug ..'
    grind: bash -c 'cmake -DRIPC_BUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Debug ..'
    {tests,clang,grind}: bash -c 'cmake --build . -j $(nproc)'
    {tests,grind}: bash -c 'ctest -V --test-dir ./'
    clang: bash -c 'cmake --build . --target coverage'
    lcov: lcov_cobertura build/coverage/lcov.info --base-dir {toxinidir} --output coverage.xml
    lint: bash -c 'cpplint --output=gsed {toxinidir}/src/* {toxinidir}/inc/*'
    auto: gcovr -s -b src/.libs/ test/
    auto: gcovr --xml-pretty -o coverage.xml src/.libs/ test/
    {bionic,tests}: gcovr -s -b -r {toxinidir} .
    bionic: gcovr -r {toxinidir} --xml-pretty -o coverage.xml .
    bionic: gcovr -r {toxinidir} --html --html-details -o {toxinidir}/coverage/coverage.html .
    {auto,bionic}: bash -c 'RIPC_RUNTIME_DIR=$ENV_RIPC_RUNTIME_DIR {toxinidir}/scripts/run_redis.sh stop'
    ctest: bash -c 'ctest --build-generator {posargs:"Unix Makefiles"} --build-and-test . build --build-options -DWITH_COVERAGE=ON -DCMAKE_BUILD_TYPE=Debug --test-command ctest --rerun-failed --output-on-failure -V'
    ctest: gcovr -s -b build/
    cover: gcovr --xml-pretty -o coverage.xml build/
    # runtime assertion error without || true =>  (SIGSEGV)) (exited with code -11)
    grind: bash -c 'valgrind --tool=memcheck --xml=yes --xml-file=json_check.xml --leak-check=full --show-leak-kinds=definite,possible --error-exitcode=127 ./json_test || true'
    # valgrind error exit without || true =>  (exited with code 127)
    grind: bash -c 'valgrind --tool=memcheck --xml=yes --xml-file=multithread_check.xml --leak-check=full --show-leak-kinds=definite,possible --error-exitcode=127 ./multithread_test || true'
    grind: bash -c 'valgrind --tool=memcheck --xml=yes --xml-file=command_check.xml --leak-check=full --show-leak-kinds=definite,possible --error-exitcode=127 ./command_result_test'
    grind: bash -c '[[ -f json_check.xml ]] && valgrind-ci json_check.xml --number-of-errors'
    grind: bash -c '[[ -f json_check.xml ]] && valgrind-ci json_check.xml --summary'
    grind: valgrind-ci multithread_check.xml --number-of-errors
    grind: valgrind-ci multithread_check.xml --summary
    # xml exception (no errors in report) =>  junk after document element
    #grind: bash -c '[[ -f command_check.xml ]] && valgrind-ci command_check.xml --number-of-errors || true'
    #grind: bash -c '[[ -f command_check.xml ]] && valgrind-ci command_check.xml --summary || true'
    clean: bash -c 'rm -rf build/ coverage/ coverage.xml'
    autoclean: bash -c 'make distclean-recursive'
    autoclean: bash -c 'rm -rf Makefile Makefile.in aclocal.m4 ar-lib autom4te.cache/ compile config.* coverage* configure configure~ depcomp install-sh libltdl/ ltmain.sh m4/ missing src/Makefile.in test-driver test/gmon.out test/Makefile.in'

commands_post =
    {tests,clang,ctest,grind}: bash -c '{toxinidir}/scripts/run_redis.sh stop > /dev/null'
